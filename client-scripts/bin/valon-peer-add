#!/bin/bash
# valon-peer-add - Add a peer to WireGuard interface
#
# Usage: valon-peer-add --pubkey <public_key> --allowed-ips <ips> [--interface wg0]

set -e

# Defaults
WG_INTERFACE="${WG_INTERFACE:-wg0}"
PUBKEY=""
ALLOWED_IPS=""
KEEPALIVE="0"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --interface)
            WG_INTERFACE="$2"
            shift 2
            ;;
        --pubkey)
            PUBKEY="$2"
            shift 2
            ;;
        --allowed-ips)
            ALLOWED_IPS="$2"
            shift 2
            ;;
        --keepalive)
            KEEPALIVE="$2"
            shift 2
            ;;
        -h|--help)
            echo "Usage: $0 --pubkey <public_key> --allowed-ips <ips> [--interface wg0] [--keepalive seconds]"
            echo ""
            echo "Options:"
            echo "  --pubkey        WireGuard public key of the peer"
            echo "  --allowed-ips   Allowed IP addresses (comma-separated)"
            echo "  --interface     WireGuard interface name (default: wg0)"
            echo "  --keepalive     Persistent keepalive interval in seconds (default: 0, disabled)"
            echo "                  Recommended: 25 seconds for peers behind NAT"
            echo ""
            echo "Example:"
            echo "  $0 --pubkey 'abc123...' --allowed-ips '100.100.0.2/32' --keepalive 25"
            exit 0
            ;;
        *)
            echo "Unknown option: $1" >&2
            echo "Use --help for usage information" >&2
            exit 1
            ;;
    esac
done

# Validate required arguments
if [[ -z "$PUBKEY" ]]; then
    echo "Error: --pubkey is required" >&2
    exit 1
fi

if [[ -z "$ALLOWED_IPS" ]]; then
    echo "Error: --allowed-ips is required" >&2
    exit 1
fi

# Check if running as root
if [[ $EUID -ne 0 ]]; then
   echo "Error: This script must be run as root (required for wg command)" >&2
   exit 1
fi

# Check if WireGuard interface exists
if ! ip link show "$WG_INTERFACE" &> /dev/null; then
    echo "Error: WireGuard interface $WG_INTERFACE not found" >&2
    exit 1
fi

echo "Adding peer to $WG_INTERFACE..."
echo "  Public key: ${PUBKEY:0:20}..."
echo "  Allowed IPs: $ALLOWED_IPS"
echo "  Keepalive: ${KEEPALIVE}s"

# Check if peer already exists
if wg show "$WG_INTERFACE" | grep -q "$PUBKEY"; then
    echo "  → Peer already exists, updating configuration..."
    wg set "$WG_INTERFACE" peer "$PUBKEY" allowed-ips "$ALLOWED_IPS" persistent-keepalive "$KEEPALIVE"
    echo "  ✓ Updated successfully"
else
    wg set "$WG_INTERFACE" peer "$PUBKEY" allowed-ips "$ALLOWED_IPS" persistent-keepalive "$KEEPALIVE"
    echo "  ✓ Added successfully"
fi
